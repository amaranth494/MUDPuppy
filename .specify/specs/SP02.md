# SP02 — Session Proxy & Live Connectivity

**Spec Identifier:** SP02PH00T00 → SP02  
**Phase:** Live MUD Connectivity  
**Status:** Proposal  
**Audience:** Product Management Review  
**Predecessor:** SP01 — Account Authentication & Session Foundation  
**Owner:** Product Engineering  
**Target:** First Live MUD Connection Capability

---

## 1. Executive Summary

SP01 delivered production-grade authentication and session control. However, users cannot yet connect to a real MUD server.

SP02 establishes the first live product capability: an authenticated user can open, maintain, and terminate a real telnet-based MUD session through a secure backend proxy, using a clearly defined and constitutionally bounded MVP user interface.

This spec introduces:

- Backend telnet proxy management
- WebSocket live streaming
- Abuse prevention enforcement
- A constitutionally defined MVP UI contract

SP02 transforms the system from authenticated shell into a functioning cloud MUD proxy.

---

## 2. Problem Statement

MUDPuppy currently provides infrastructure (SP00) and production-grade authentication/session control (SP01). However, users cannot yet connect to a real MUD server.

SP02 solves this by introducing:

- Outbound TCP telnet connection capability
- Real-time bidirectional streaming via WebSocket
- Connection lifecycle enforcement (idle timeout, hard cap)
- Abuse prevention guardrails
- MVP UI contract for the Play experience

Without live connectivity, MUDPuppy is merely an authenticated shell with no functional purpose.

---

## 2a. User-Facing Behavior Description

The user experience flow for SP02:

1. **Authenticated User** navigates to Play screen
   - Sees connection panel with Host and Port fields
   - Default port is 23 (telnet)

2. **Connection Initiation**
   - User enters host (e.g., "ironrealms.com")
   - User enters port (default: 23)
   - User clicks Connect
   - Status indicator shows "Connecting"
   - Backend initiates outbound telnet connection

3. **Connected Session**
   - Status indicator shows "Connected" (green)
   - Command input is enabled
   - User types commands, presses Enter
   - Output streams to terminal panel in real-time

4. **Disconnection**
   - User clicks Disconnect OR
   - Idle timeout triggers (30 min) OR
   - Hard session cap triggers (24 hours) OR
   - Remote server closes connection
   - Status returns to "Disconnected"
   - User can reconnect

5. **Error States**
   - Invalid host: "Could not resolve host"
   - Connection refused: "Connection refused by server"
   - Timeout: "Connection timed out"
   - Private IP attempt: "Private addresses not allowed"
   - Invalid port: "Port must be between 1-65535"

---

## 3. Scope Definition

### 3.1 Backend (Service Layer)

All socket handling remains server-side in compliance with Service-First Architecture (Constitution II.b).

#### 3.1.1 Outbound TCP Telnet Connection Manager

- TCP dialer to connect to arbitrary host:port
- Per-user isolated session binding (one session per authenticated user)
- Connection lifecycle management

#### 3.1.2 Connection Lifecycle Enforcement

| Event | Behavior |
|-------|----------|
| connect | User initiates connection to MUD server |
| disconnect | User disconnects or remote closes |
| idle timeout | 30 minutes of **no activity** → forced disconnect |
| hard session cap | 24 hours absolute max → forced disconnect |

**Activity Definition:**
- Inbound data from MUD server (e.g., game output, prompts)
- OR outbound command from user (sent to MUD)

Either direction counts as activity and resets the idle timer.

#### 3.1.3 Abuse Prevention Enforcement

- **Whitelisted outbound ports:** 23 (telnet), optionally configurable
- **Future allowed:** 22 (SSH), 80/443 (HTTP gateways)
- **Private IP blocking:** Reject connections to 10.x.x.x, 172.16-31.x.x, 192.168.x.x, 127.x.x.x, localhost
- **64KB message size limit:** Per-message cap on both directions (inbound MUD payload, outbound client command)
- **Flood detection:** Rate limit commands (e.g., max 10 commands/second)
- **Session logging:** Connection metadata only (connect time, host, port, duration, disconnect reason)

#### 3.1.4 Protocol Handling

- Initial MVP: Raw telnet pass-through
- **Frontend Framework:** React + TypeScript (SPA)
- ANSI-equivalent rendering allowed under Constitution II.a MVP exception
- Backend passes through sanitized ANSI-capable text to frontend terminal renderer
- **Telnet Negotiation:**
  - The backend MUST consume all IAC (0xFF) negotiation bytes
  - The browser MUST NEVER receive telnet negotiation sequences
  - Only application-layer text reaches frontend
  - Backend terminates telnet option negotiation (will IAC, wont IAC, etc.)

**Post-MVP Migration:** Structured render events (future spec) will replace ANSI passthrough.

### 3.2 API Surface

All endpoints require authentication (SP01 session valid).

#### 3.2.1 REST Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | /api/v1/session/connect | Initiate MUD connection |
| POST | /api/v1/session/disconnect | Terminate MUD connection |
| GET | /api/v1/session/status | Get current connection state |

#### 3.2.2 WebSocket Endpoint

| Protocol | Endpoint | Description |
|----------|----------|-------------|
| WSS | wss://host/api/v1/session/stream | Live bidirectional streaming |

**WebSocket Lifecycle:**

1. Client authenticates via existing session cookie
2. Client sends JSON message: `{"action": "connect", "host": "...", "port": 23}`
3. Server dials MUD, streams data bidirectionally
4. Either side can close; server cleans up MUD connection

#### 3.2.3 API Versioning

Must comply with constitutional API versioning rules (Constitution III.d): `/api/v1/` prefix, version in URL path.

### 3.3 MVP UI Contract

SP02 includes a Minimum UI Implementation that becomes part of the enforceable MVP contract (Constitution V). This section is binding.

#### 3.3.1 Global App Shell (Authenticated)

Always visible on authenticated pages:

- **Top App Bar:** App name/logo (click → Home/Play)
- **Session Status Pill:** Disconnected (gray) | Connecting (yellow) | Connected (green) | Error (red)
- **Account Menu:** Account, Help, Sign Out
- **Primary Navigation:** Play | Connections | Account | Help

No persistent browser-local storage may be required for correctness (Constitution V.a).

#### 3.3.2 Play Screen (Primary MVP Experience)

Must include:

**Connection Panel**

- Host input field (text, required)
- Port input field (number, default: 23)
- Connect button
- Disconnect button (visible only when connected)

**Output Panel**

- Scrollable terminal rendering area
- ANSI-equivalent rendering allowed under Constitution II.a MVP exception
- No raw escape sequences rendered without backend control

**Input Row**

- Command input field
- Enter-to-send behavior
- Send button (optional)
- Disabled when disconnected

#### 3.3.3 Connection State Machine

The UI must implement this state machine:

| State | Connect Panel | Output Panel | Status Pill |
|-------|--------------|--------------|-------------|
| Disconnected | Enabled | Empty/Last session end | Gray |
| Connecting | Disabled | "Connecting..." spinner | Yellow |
| Connected | Disconnect enabled | Active session | Green |
| Error | Enabled | Error banner | Red |

#### 3.3.4 Required Dialogs & Error States

SP02 must include:

- **Invalid Host/Port validation:** Inline error messages
- **Connection failure notice:** Modal or banner with reason
- **Forced disconnect notice:** Idle timeout, hard cap, remote close
- **Optional:** Idle warning (recommended but not required)

All error states must be user-visible and testable via browser-only QA.

#### 3.3.5 Connections Page (Minimal)

If included, must allow:

- Add connection (host, port, optional name)
- Edit host/port
- Delete saved connection
- Connect from saved entry

Data persists server-side (not browser-local) per Constitution V.a.

**Storage:** Saved connections stored in Postgres (`mud_saved_connections` table).

| Column | Type | Description |
|--------|------|-------------|
| id | UUID | Primary key |
| user_id | UUID | Foreign key to users |
| name | VARCHAR(255) | Connection name |
| host | VARCHAR(255) | MUD hostname |
| port | INTEGER | MUD port (default 23) |
| created_at | TIMESTAMP | Creation timestamp |
| updated_at | TIMESTAMP | Last modified |

Redis stays reserved for ephemeral session state (auth sessions, live connection handles, TTL timers).

### 3.4 Required Environment Variables (New)

- MUD_PROXY_PORT_WHITELIST - Comma-separated ports (default: "23")
- IDLE_TIMEOUT_MINUTES - Default: 30
- HARD_SESSION_CAP_HOURS - Default: 24
- MAX_MESSAGE_SIZE_BYTES - Default: 65536 (64KB per message, both directions)
- COMMAND_RATE_LIMIT_PER_SECOND - Default: 10
- WEBSOCKET_PING_INTERVAL_SECONDS - Default: 30

### 3.5 Database Schema (New for SP02)

**mud_saved_connections** (Postgres)

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PK | Primary key |
| user_id | UUID | FK → users(id), NOT NULL | Owning user |
| name | VARCHAR(255) | | Connection display name |
| host | VARCHAR(255) | NOT NULL | MUD hostname |
| port | INTEGER | NOT NULL, DEFAULT 23 | MUD port |
| created_at | TIMESTAMP | DEFAULT NOW() | Creation timestamp |
| updated_at | TIMESTAMP | DEFAULT NOW() | Last modified |

**Rationale:** Saved connections are user configuration and must survive restarts, deploys, and device changes. Redis stays reserved for ephemeral session state.

### 3.6 Observability Guidance

**Note:** Metrics instrumentation SHOULD begin in PH01 (connection start/end events) to avoid refactoring later. PH04 focuses on SLO exposure and dashboard integration, but base metrics should be implemented during PH01.

Metrics to capture:
- Connection attempts (success/failure)
- Connection duration
- Commands sent
- Data transferred (in/out bytes)
- Disconnect reasons (user, idle, hard cap, error)

---

## 4. Explicit Non-Goals

SP02 does NOT include:

- **Multi-session tabs** — One connection at a time
- **SSH implementation** — Telnet only for MVP
- **Automation engine** — Aliases, triggers, timers (future spec)
- **Trigger editor** — (future spec)
- **Alias editor** — (future spec)
- **Macro panels** — (future spec)
- **Automapper** — (future spec)
- **Rich UI overlays** — Health bars, panels (future spec)
- **Persistent session logs UI** — (future spec)
- **Script debugging** — (future spec)
- **Advanced protocol inspection** — GMCP, MCCP (future spec)
- **Desktop-era feature parity with CMUD/zMUD** — Per Constitution preamble

SP02 is connectivity only.

---

## 5. Architectural Impact

SP02 introduces:

- **Session Manager component:** Tracks active MUD connections per user
- **WebSocket bridge:** Relays data between MUD server and browser
- **Protocol handling groundwork:** Foundation for future MCCP/GMCP
- **Resource enforcement hooks:** Connection limits, rate limiting

It must NOT:

- **Break SP01 authentication** — Existing sessions remain valid
- **Introduce Railway-specific runtime coupling** — Portable to any host
- **Introduce browser-side socket logic** — All outbound from backend (Constitution II.b)

All outbound connections originate from backend only.

---

## 6. Phase Breakdown

### PH00 — Branch Creation

- Create branch: `sp02-session-proxy`
- Spec committed to branch
- CI passes
- Branch from staging

### PH01 — Backend Connection Manager

**Tasks:**

- TCP dialer implementation
- Port whitelist enforcement
- Private IP detection
- Per-user session binding
- Idle timer enforcement
- Hard cap enforcement
- Metadata logging (connection metadata only)

**Acceptance:**

- Backend connects to test MUD server
- Disconnect and cleanup verified

### PH02 — WebSocket Bridge

**Tasks:**

- WSS endpoint implementation
- Stream relay (bidirectional: MUD → client, client → MUD)
- Message size enforcement
- Flood protection / rate limiting
- Proper session teardown on close

**Acceptance:**

- Live stream visible in terminal
- No resource leaks
- No session crossover between users

### PH03 — UI Implementation

**Tasks:**

- Global app shell components
- Play screen with connection panel
- Connect/disconnect controls
- Session status indicator
- Error messaging
- Disabled states enforcement

**Acceptance:**

- UI matches MVP contract (Section 3.3)
- All states visible and testable via browser-only QA

### PH04 — Abuse & Resource Enforcement

**Tasks:**

- Connection limit hooks
- Throughput limits
- Observability metrics
- Fail-fast invalid connection handling

**Acceptance:**

- Abuse rules demonstrably enforced
- Private IPs blocked
- Invalid ports rejected

### PH05 — QA Phase (Mandatory)

QA must test (browser-only, no database access):

- Successful connect to test MUD
- Failed connect (invalid host, refused, timeout)
- Idle timeout triggers at 30 minutes
- Hard cap triggers at 24 hours
- Disconnect button works
- Rapid connect/disconnect sequences
- Two users simultaneously (isolation verified)
- Invalid host error message
- Invalid port error message
- Private IP attempt blocked

**Spec fails if QA cannot validate behavior via UI alone.**

### PH06 — Final Phase: Merge & Deployment

**Flow:** `sp02-session-proxy` → staging → master

**Requirements:**

- CI passing
- QA sign-off (browser-only validation)
- Code review complete
- Staging validated
- Production verification

---

## 7. Acceptance Criteria

### Feature-Level Acceptance Criteria

| ID | Criterion | Test Method |
|----|-----------|-------------|
| SP02-AC01 | Authenticated user can connect to a real MUD server | Browser QA |
| SP02-AC02 | User can send commands and receive output in real-time | Browser QA |
| SP02-AC03 | Idle timeout disconnects user after 30 minutes | Timer test |
| SP02-AC04 | Hard cap disconnects user after 24 hours | Timer test |
| SP02-AC05 | Private IP connections are rejected with clear error | Browser QA |
| SP02-AC06 | Invalid ports are rejected with clear error | Browser QA |
| SP02-AC07 | No cross-user session leakage occurs | Multi-user test |
| SP02-AC08 | UI state transitions are accurate (Disconnected→Connecting→Connected→Disconnected) | Browser QA |
| SP02-AC09 | QA can validate all behavior from browser only | Browser QA |
| SP02-AC10 | WebSocket connection closes when authentication session expires | Manual test |

### Task-Level Acceptance Criteria

Each phase has specific acceptance criteria defined in the Phase Breakdown (Section 6).

---

## 8. Strategic Result

After SP02:

- MUDPuppy is a real, live MUD proxy platform
- Users can connect to actual MUD servers
- MVP UI contract is enforceable
- Guardrails prevent abuse

Future specs build on:

- Automation engine (aliases, triggers, timers)
- Structured render events
- Rich UI overlays
- SSH support
- Advanced protocol handling (MCCP, GMCP)

SP02 is the network foundation.

---

## 9. Dependencies

- **SP00** — Environment & Infrastructure Foundation (complete)
- **SP01** — Account Authentication & Session Foundation (complete)
- Railway hosting (SP00)
- Redis for session state (SP01)
- PostgreSQL for user data (SP01) + saved connections

---

## 10. Test MUD Servers

### Public Smoke-Test Targets

| MUD | Host | Port | Notes |
|-----|------|------|-------|
| Aardwolf | aardmud.org | 23 | Explicitly open for telnet users |
| BatMUD | bat.org | 23 | Official ecosystem support |

---

## 12. Deployment Governance (Constitution VIII)

Per Constitution VIII. Deployment Governance & Environment Integrity:

### Branch-to-Environment Mapping

| Branch | Environment | Purpose |
|--------|-------------|---------|
| master | Production | Live system |
| staging | Staging | Integration & QA |
| sp02-session-proxy | Feature branch | Spec implementation |

### Promotion Flow

**sp02-session-proxy → staging:**
```
git push origin sp02-session-proxy:staging
```

**staging → master (after QA):**
```
git push origin staging:master
```

### Pre-Promotion Verification (VIII.4)

Before any branch promotion, confirm:

1. **Local branch:** `git branch` + `git status`
2. **Remote target:** `git branch -a`
3. **Railway environment:** `railway status` → must show correct environment

### Railway CLI Governance (VIII.3)

- Railway CLI only for: status, logs, emergency deployment
- Must verify environment with `railway status` before any deployment
- **Environment ambiguity is prohibited**
- Use `railway unlink` → `railway link` → `railway status` if uncertain

### Production Protection (VIII.5)

- Production only via `git push origin staging:master`
- No direct `railway up` to production
- Only after: tasks complete, QA done, acceptance criteria verified

### Emergency Protocol (VIII.6)

If Railway CLI deployment required:
1. Document justification in Spec
2. Run `railway status` and verify environment
3. Preserve output in Spec record

---

## 13. Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| MUD server compatibility | Medium | Test with multiple real MUDs |
| WebSocket scaling | Medium | Proper resource cleanup, connection limits |
| Abuse from open proxy | High | Strict port whitelist, private IP block |
| State sync issues | Low | Server-side state, WSS relay model |

---

**Spec Status:** Proposal  
**Next Phase:** Branch creation (PH00) upon approval
