# SP03 — Persistent App Shell & Connections Manager (MVP)

> **Spec ID:** SP03  
> **Status:** Proposed  
> **Author:** Product Lead  
> **Branch Prefix:** sp03-persistent-shell-connections

---

## 1. Problem Statement

The current UI treats gameplay as a page rather than as a persistent application state. Navigating the interface risks unmounting the session or visually breaking immersion. Additionally, users cannot persist or manage multiple MUD connections in a structured way.

This results in:

- Fragile session continuity
- Lack of saved connection workflows
- No clear application shell structure for future tools
- Poor foundation for advanced builders (triggers, aliases, variables)

SP03 establishes a persistent application shell and introduces a production-grade Connections Manager MVP.

---

## 2. Objectives

SP03 must deliver:

1. **Persistent Play Layer**
   - Gameplay session remains mounted and connected during UI navigation
   - WebSocket connection is not tied to route-level unmounts

2. **Sidebar Drawer Navigation**
   - Replace header controls with a collapsible sidebar
   - Sidebar becomes primary navigation spine

3. **Modal Workspace System**
   - All tool interfaces render in a modal layer
   - Modal overlays do not terminate or reset gameplay
   - Input safety enforced while modal is active

4. **Connections Manager (MVP)**
   - Per-user saved connections (CRUD)
   - Quick Connect from Play
   - Recent Connections list (server-sourced)
  - **Definition:** Top 5 connections ordered by last_connected_at DESC where last_connected_at IS NOT NULL
   - Explicit connect/disconnect lifecycle

---

## 3. Non-Goals (Explicitly Out of Scope)

SP03 will NOT include:

- Credential encryption vault or auto-login scripts
- Trigger or alias builders
- Automation UI work
- Per-connection keymap editing (can be stubbed if needed)
- Multi-session per user
- SSH implementation
- AI integration
- Pop-out windows (modal-only architecture for now)
- Changes to backend session proxy logic

> **This is a navigation + persistence spec, not a feature explosion spec.**

---

## 4. Feature Set

### 4.1 Persistent App Shell

**Requirements:**

- Play session component must live at the application root
- Route changes must NOT unmount:
  - Terminal renderer
  - WebSocket
  - Session state
- Session badge visible at all times (Connected / Connecting / Disconnected)
  - **Source of Truth:** Must derive from GET /api/v1/session/status (Constitution IX)
  - Must NOT infer solely from WebSocket open/close events

**Acceptance Criteria:**

- User opens Help → session remains connected
- User opens Connections → session remains connected
- Scrollback remains intact across all navigation
- No reconnect occurs when opening/closing modal tools

---

### 4.2 Sidebar Drawer

**Structure:**

**Top:**
- MUDPuppy logo (returns focus to Play; does not disconnect)

**Primary Items:**
- Play (opens Quick Connect modal)
- Connections (opens Connections Hub modal)

**Bottom:**
- Help
- User Menu
- Account
- Sign Off

**Behavior:**

- Sidebar is a collapsible drawer
- Drawer toggle button always accessible
- Drawer toggle is UI-only (no session impact)
- Collapsed state shows icons only
- **Storage:** Drawer state is ephemeral (in-memory only); must NOT persist to localStorage (per Constitution V.a)

**Acceptance Criteria:**

- Drawer can open/close without impacting session
- Navigation does not trigger reconnects
- Play remains mounted regardless of drawer state

---

### 4.3 Modal Workspace System

**Requirements:**

- All tools render inside a modal overlay
- Modal:
  - Full-height
  - Close button + ESC support
  - Input capture enabled
- When modal open:
  - Gameplay input locked
  - Terminal still renders output underneath
- On modal close:
  - Focus returns to terminal

**Acceptance Criteria:**

- No keystrokes leak to MUD while modal active
- **UX Discipline:** Only command submission is locked; terminal rendering and text selection (Ctrl+C) must still work
- Closing modal restores terminal input immediately
- High ANSI bursts during modal do not crash UI

---

### 4.4 Quick Connect (Play)

**Fields:**
- Host
- Port

**Behavior:**

- Connect only occurs on explicit user action
- Does not auto-save connection
- Uses existing backend control-plane flow
- Server remains authoritative for session status

**Acceptance Criteria:**

- User can connect via Quick Connect
- Disconnect and reconnect works
- Session state matches backend truth

---

### 4.5 Connections Manager (MVP)

#### Backend

**Database Table:** `connections`

**Fields:**
- `id` (UUID)
- `user_id` (UUID)
- `name` (VARCHAR)
- `host` (VARCHAR)
- `port` (INTEGER)
- `protocol` (VARCHAR, default: telnet)
- `created_at` (TIMESTAMP)
- `updated_at` (TIMESTAMP)
- `last_connected_at` (TIMESTAMP, optional)

> **No secrets stored.**

**Schema Migration Requirements:**
- Must use migration tool
- Must be reversible (up/down)
- Versioned
- No ad-hoc SQL at runtime

---

#### UI — Connections Hub Modal

**Default View:**
- List saved connections
- Recent connections (server-derived)

**Actions:**
- Connect
- Edit
- Delete
- New Connection

**Behavior Rules:**
- No auto-connect on login
- Explicit user connect only
- Deleting connection does not affect active session
- Editing connection does not auto-reconnect

**Acceptance Criteria:**

- User can create, edit, delete saved connections
- Recent connections reflect actual usage
- Connections persist across logout/login
- QA can validate all behavior via browser only

---

## 5. Architectural Guardrails

These are mandatory.

### 5.1 Session Authority Boundary

- WebSocket stream remains isolated from UI routing
- Modal must not dial TCP
- Session Manager remains sole connection authority

### 5.2 Backend is Authoritative

- UI reflects `/session/status`
- No localStorage for connection persistence
- No client-truth state assumptions

### 5.3 Observability Discipline

- If new metrics are introduced: instrument before enforcing
- No silent hard limits added in SP03

### 5.4 Input Safety

- Modal open → terminal input locked
- No accidental command leakage
- Focus control deterministic

### 5.5 No Scope Creep

Avoid:
- Credential vault logic
- Complex profile systems
- Automation UI
- Multi-session support
- Render abstraction refactors

> **SP03 is navigation + connection persistence only.**

---

## 6. Risk Areas (Lessons Applied)

From SP02:

- Do not tie transport deadlines to UI navigation
- Do not enforce unmeasured limits
- Do not introduce reconnect behavior implicitly
- Do not allow feature to bypass rate limits
- Do not collapse control/data plane boundaries

> **SP03 must remain a UI + persistence enhancement, not a network architecture change.**

### Known Risks

**Terminal Resize Stability:**

- xterm.js may exhibit reflow issues under rapid or repeated container width changes (sidebar collapse/expand, drag resize)
- Mitigated by: SP03PH07T06b terminal resize stability test
- If issues persist: implement debounced resize observer, or defer resize events until after transition completes

**Focus Management:**

- Adding overlay layers (modals, drawers, tooltips) increases focus management complexity; keystrokes may leak to wrong target or lose focus entirely
- Mitigated by: SP03PH07T06c focus & keystroke integrity test, SP03PH07T05 modal input lock test
- If issues persist: implement focus trap in modal component, use useEffect cleanup to restore focus on unmount

---

## 7. Deployment & Branch Governance

SP03 must follow constitutional lifecycle.

### Phase 0 — Branch Creation (SP03PH00)

- Branch from `master`
- Branch name: `sp03-persistent-shell-connections`
- Commit Spec document before development
- CI must pass
- **No feature work before Phase 0 completes**

### Development Phases

| Phase | Description |
|-------|-------------|
| SP03PH01 | Persistent App Shell |
| SP03PH02 | Sidebar Drawer |
| SP03PH03 | Modal Workspace Container |
| SP03PH04 | Quick Connect |
| SP03PH05 | Backend Migrations + Connections CRUD |
| SP03PH06 | Connections Hub UI |
| SP03PH07 | QA Phase |

Each phase:
- Must have tasks with measurable output
- Must have acceptance criteria
- Must pass CI

### QA Phase (Mandatory)

QA must validate using:
- Browser only
- Normal user account
- No DB access
- No logs access

QA must test:
- Session continuity across navigation
- Connection CRUD
- Quick Connect
- Drawer toggle behavior
- Modal input lock
- Error handling (invalid host, invalid port, deny-listed port, private IP blocked, DNS failure, timeout)
  - Error messages must distinguish between: Invalid input, Deny-listed port, Private IP blocked, DNS failure, Timeout

QA produces:
- Pass/fail report referencing SP03 task IDs

### Final Phase — Merge & Close

Conditions:
- All tasks complete
- QA passed
- CI green
- Code review complete

Merge flow:
1. Feature branch → staging
2. Staging validation
3. staging → master
4. Railway auto-deploy
5. Production verification
6. Spec marked Closed

**No direct CLI pushes.**  
**No manual production changes.**

---

## 8. Definition of Done

SP03 is complete only when:

- [ ] Play remains persistent across all navigation
- [ ] Sidebar fully replaces header navigation
- [ ] Modal system stable and input-safe
- [ ] Connections persist per user
- [ ] QA validates via browser-only workflow
- [ ] Deployment verified in production

---

## 9. Success Definition

After SP03, the product transitions from:

> **"Authenticated proxy with a play page"**

To:

> **"Persistent, structured, multi-connection cloud MUD client."**

That is a meaningful, user-visible maturity step.

---

## 10. Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2026-02-23 | Initial spec draft |

---

**Constitutional Reference:** This spec is governed by Constitution VIII (Deployment Governance) and Constitution IX (Transport Layer Governance).
