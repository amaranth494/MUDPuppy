# SP01 — Account Authentication & Session Foundation

**Spec Identifier:** SP01PH00T00 → SP01  
**Phase:** Identity & Session Scaffolding  
**Status:** Proposal  
**Audience:** Product Management Review  
**Predecessor:** SP00 — Environment & Infrastructure Foundation  
**Owner:** Product Engineering  
**Target:** First User-Capable System State

---

## 1. Executive Summary

SP01 introduces the first user-visible capability of the platform:

Authenticated user accounts with persistent identity and server-managed session lifecycle.

This Spec establishes the minimum necessary identity layer required to unlock all future features (MUD connections, automation, logging, persistence), while preserving SP00's deterministic infrastructure guarantees.

SP01 does not introduce MUD connectivity, automation engines, or protocol handling.

It introduces identity and session scaffolding only.

---

## 2. Problem Statement

SP00 delivered a stable runtime foundation but the system currently:

- Has no concept of a user
- Has no persistent identity
- Cannot securely associate state with a human actor
- Cannot enforce multi-tenant isolation

Without authentication and session ownership, no feature can safely progress.

SP01 solves this by introducing:

- Secure account creation
- Authentication
- Server-side session management
- Persistent identity storage

This is the minimal viable identity layer required for the product to exist meaningfully.

---

## 2a. User-Facing Behavior Description

The user experience flow for SP01:

1. **Unauthenticated User** visits the application
   - Sees login page with "Register" option
   - Cannot access any protected features

2. **Registration Flow**
   - User enters email address
   - System sends OTP to email
   - User enters OTP to complete registration
   - User is now logged in

3. **Authenticated User**
   - Can access protected API endpoints
   - Session persists across browser refreshes
   - Can log out at any time

4. **Logout**
   - User clicks logout
   - Session invalidated immediately
   - Redirected to login page

5. **Session Expiry**
   - After 24 hours of activity, session expires
   - After 30 minutes of idle, session expires
   - User must re-authenticate

---

## 3. Scope Definition

### 3.1 Account Creation

- Email-based account registration
- Email-based OTP authentication (no password storage in MVP)
- Secure token issuance
- JWT or session-token model (server-validated)

### 3.2 Session Lifecycle

- Login
- Logout
- Token expiration
- Session validation middleware
- **Sessions stored in Redis only** (database stores user identity only)
- Sessions are ephemeral and not persisted in Postgres
- Sessions may be invalidated if Redis restarts (acceptable for MVP)
- **OTP stored in Redis** with key format `otp:email:{sha256(lower(email))}`, TTL 15 minutes
- **Session TTL:** Absolute max = 24 hours (hard cap), Idle timeout = 30 minutes (sliding)

**TTL Implementation:**
- **OTP:** Use SET key EX 900 (atomic, 15 min)
- **Session dual-key approach:**
  - `session:{id}` - holds session payload, hard cap EX 86400 (24h)
  - `session_idle:{id}` - idle marker, sliding EX 1800 (30 min), updated on activity
  - Middleware checks both: session exists (hard cap) AND idle marker exists (not idle)

### 3.3 Database Schema (Initial)

**Tables:**
- users

**Requirements:**
- Migration tooling required
- No destructive schema operations

**Note:** Sessions and OTPs are Redis-only (not stored in Postgres)

### 3.4 Authenticated API Access

- /api/v1/me
- Auth middleware enforcement
- 401 / 403 handling

### 3.5 Minimal Frontend UI

- Login screen
- Registration flow
- Logged-in indicator
- Logout control
- No dashboard complexity

---

## 4. Explicit Non-Goals

SP01 will not introduce:

- MUD connections
- Telnet/SSH
- WebSocket streams
- Automation rules
- Structured render events
- User profile customization
- Role-based access control
- Admin dashboards
- OAuth social login
- Password-based auth
- Email templating sophistication

SP01 is identity scaffolding only.

---

## 5. Architectural Impact

SP01 extends but does not alter:

- Railway hosting model
- CI/CD pipeline
- Deterministic version pinning
- Fail-fast startup behavior

SP01 introduces:

- Migration system (versioned)
- Auth middleware layer
- Redis usage (if session-backed)
- JWT signing secret (environment variable)

All new environment variables must:

- Be documented
- Fail-fast if missing

---

### Email Delivery (MVP)

- MVP: Uses SMTP (credentials provided by owner)
- Post-MVP: Transition to licensed domain with transactional email provider
- Environment variables: SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS
- Fail-fast if SMTP misconfigured
- For local development, OTP may be logged to console (dev only)
- **SMTP Failure Behavior:** If SMTP fails → do NOT store OTP in Redis → return 503 Service Unavailable

---

### Required Environment Variables (New)

- SESSION_SECRET - Required, startup panics if missing
- SMTP_HOST - Required for email delivery
- SMTP_PORT - Required for email delivery
- SMTP_USER - Required for email delivery  
- SMTP_PASS - Required for email delivery
- EMAIL_FROM_ADDRESS - Required
- OTP_EXPIRY_MINUTES - Optional (default: 15)

**Startup must panic if SESSION_SECRET missing.**

---

## 6. Security Model

### Authentication Method (MVP)

**Email-based One-Time Password (OTP).**

**Why:**
- No password storage complexity
- No hashing strategy required
- Reduced breach surface
- Faster to implement safely

### Token Handling

**Option A:** Signed JWT with short expiration  
**Option B:** Opaque session ID + Redis validation

**Recommendation for MVP:** Opaque session ID + Redis validation.

**Reason:**
- Allows forced invalidation
- Safer revocation model
- Cleaner multi-tenant isolation

### Security Constraints

- Never log tokens
- Never log email verification codes
- 15-minute OTP expiry
- 24-hour session max duration (absolute hard cap)
- 30-minute idle timeout (resets on activity)
- **CSRF:** Not required — SameSite=Lax cookie prevents cross-site requests
- **Session validation must be middleware-based** and required for all protected API routes by default

---

### Abuse Controls (MVP)

- Max 5 OTP requests per email per hour
- Max 10 login attempts per IP per 10 minutes
- Return 429 when limit exceeded
- **Abuse Logging:** Log rate-limit violations (IP, endpoint, timestamp) without PII
- Log repeated abuse attempts per IP for later analysis

---

## 7. Acceptance Criteria

### Feature-Level Acceptance Criteria

A user must be able to:

- Register using email.
- Receive OTP.
- Authenticate using OTP.
- Remain logged in across refresh. **Session cookie HTTP-only, SameSite=Strict or Lax, not stored in LocalStorage. Cookie expiration matches 24-hour max session duration. Idle timeout enforced server-side.**
- Log out successfully.
- Be denied access to protected API routes without authentication.

**See appropriate error messages for:**
- Invalid OTP
- Expired OTP
- Invalid session

**Response times:**
- Auth request < 500ms (p95)
- Session validation < 100ms

### Task-Level Acceptance Criteria

Each task must:

- Be independently testable
- Pass CI
- Not introduce console errors
- Not expose secrets in logs
- Preserve /health endpoint behavior

---

### QA Scenarios

PM and QA must verify:

- Login from clean browser (incognito)
- Logout invalidates cookie
- Expired OTP rejected with appropriate message
- Direct access to /api/v1/me without session returns 401
- Idle timeout enforced after 30 minutes
- Rate limiting returns 429 when exceeded

**Hardening Validation:**

- OTP reuse fails (cannot use same OTP twice)
- Logout invalidates session immediately (not on next request)
- 24-hour hard cap enforced (session dies after 24h regardless of activity)
- Middleware protects all /api/v1/* endpoints by default

---

## 8. Operational Safeguards

SP01 must not regress SP00 guarantees:

- No direct pushes to master
- CI required before merge
- Fail-fast on missing env vars
- No debug endpoints
- Deterministic builds

**Additionally:**

**Migration Safety:**
- All migrations reversible
- No auto-drop
- Backward-compatible schema changes

**Rollback Safety:**
- Previous deploy must not crash against new schema.

---

## 9. Observability Expectations

**Logging:**
- Log auth success/failure (without sensitive data)
- Log session creation/destruction
- Log startup configuration validation

**No:**
- Payload dumps
- Credential logging
- Excessive debug noise

Production log level defaults to INFO.

---

## 10. Definition of Done

SP01 closes only when:

- [ ] Feature works locally
- [ ] Feature works in Railway
- [ ] CI passes
- [ ] QA phase passes (browser-only validation)
- [ ] /health unchanged
- [ ] Production URL stable
- [ ] No secrets exposed
- [ ] Migration verified safe
- [ ] Logout invalidates session correctly

---

## 11. Risk Assessment

| Risk | Mitigation |
|------|------------|
| Session leakage | Redis-backed validation |
| Token replay | Expiration + rotation |
| OTP abuse | Rate limiting per email/IP |
| Migration lockup | Reversible migration policy |
| Silent auth fallback | Explicit 401 enforcement |

---

## 12. Strategic Value

SP01 establishes:

- Multi-tenant enforcement capability
- Identity boundary for automation engine
- Foundation for persistent MUD sessions
- Basis for quota enforcement
- Basis for abuse prevention tracking

Without SP01, the product cannot progress safely.

---

## 13. Why This Is the Correct First Feature

It:

- Unlocks every future capability
- Introduces no irreversible architecture
- Preserves portability
- Avoids premature feature creep
- Aligns with Constitution §Modern Web Application Standards

Respects Spec Governance lifecycle requirements.

It is the smallest meaningful vertical slice of a real product.

---

### Future Extensibility Note

SP01's session model must support future WebSocket authentication handshake without redesign.

---

## Status

**Phase:** PH00 — Proposal  
**Status:** Open (Proposal)  
**Created:** 2026-02-20
